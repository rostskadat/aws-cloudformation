#
# FILE: 02-inspector.yaml
#
# DESCRIPTION: This Stack create the AWS Inspector element to be able to assess the different stack security 
#
# TODO: 
# - Should use https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/parameters-section-structure.html#aws-specific-parameter-types
# - Should provide alert when the platform is unhealthy
#
---
AWSTemplateFormatVersion: "2010-09-09"
Description: "This stack creates the AWS Inspector elements"
Metadata:
  'AWS::CloudFormation::Interface':
    ParameterGroups:
    - Label:
        default: 'Parent VPC Stack'
      Parameters:
      - ParentVpcStack
    - Label:
        default: 'EC2 Parameters'
      Parameters:
      - KeyName
Parameters: 
  ParentVpcStack: 
    Description: "Enter the name of the VPC Parent Stack"
    Type: String
    MinLength: 1
    ConstraintDescription: 'must be the name of the parent VPC stack (01-vpc.yaml)'
  KeyName: 
    Description: "Enter the name of the Key Pair for your instances"
    Type: "AWS::EC2::KeyPair::KeyName"
    MinLength: 1
    ConstraintDescription: 'must be the name of an existing Key Pair to use to log to the EC2 Instance'
Resources:
  ResourceGroup: 
    Type: 'AWS::Inspector::ResourceGroup'
    Properties:
      ResourceGroupTags: 
        - Key: PLATFORM
          Value: XXX 
  AssessmentTarget: 
    Type: 'AWS::Inspector::AssessmentTarget'
    Properties:
      AssessmentTargetName: !Sub 'Assessment Target for the ${ParentVpcStack} Stack'
      ResourceGroupArn: !GetAtt ResourceGroup.Arn
  AssessmentTemplate:
    Type: 'AWS::Inspector::AssessmentTemplate'
    Properties:
      AssessmentTargetArn: !GetAtt AssessmentTarget.Arn
      DurationInSeconds: 3600
      AssessmentTemplateName: !Sub 'Assessment Template for the ${ParentVpcStack} Stack'
      RulesPackageArns: 
        - 'arn:aws:inspector:us-west-2:758058086616:rulespackage/0-11B9DBXp'
      UserAttributesForFindings: 
        - Resource Tag
Outputs: 
  