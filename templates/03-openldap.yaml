#
# FILE: 05-gitlab.yaml
#
# DESCRIPTION: This Stack create a OpenLDAP Host that will be used by subsequent stack to manage Identification.
#
# NOTE: in order to create the AMI mapping you can run the following command. (needs a bit of massaging: 
#   should extract the ami and the region name, and output everything in the YAML compatible format)
# 
# for region in $(aws ec2 describe-regions --query 'Regions[*].{Name:RegionName}' --output text); do
#   aws --region $region ec2 describe-images --owners amazon --filters "Name=name,Values=amzn-ami-hvm-$(date +%Y)*-gp2" "Name=architecture,Values=x86_64" "Name=root-device-type,Values=ebs" --query 'Images[*].{ID:ImageId}'
# done
#
# TODO: 
# - Should use https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/parameters-section-structure.html#aws-specific-parameter-types
# - Should provide alert when the platform is unhealthy
#
---
AWSTemplateFormatVersion: "2010-09-09"
Description: "This stack create a OpenLDAP host"
Metadata:
  'AWS::CloudFormation::Interface':
    ParameterGroups:
    - Label:
        default: 'Parent Stack'
      Parameters:
      - ParentVpcStack
    - Label:
        default: 'EC2 Parameters'
      Parameters:
      - KeyName
      - InstanceType
    - Label:
        default: 'LDAP Parameters'
      Parameters:
      - RootDC
      - ManagerPassword
Parameters: 
  ParentVpcStack: 
    Description: "Enter the name of the VPC Stack where OpenLDAP will reside"
    Type: String
    MinLength: 1
    ConstraintDescription: 'must be the name of the parent VPC stack (01-vpc.yaml)'
  KeyName: 
    Description: "Optional Key Pair to connect through SSH"
    Type: "AWS::EC2::KeyPair::KeyName"
  InstanceType:
    Description: 'The LDAP instance type'
    Type: 'String'
    Default: 't2.micro'    
  RootDC: 
    Description: 'The LDAP Root DC element'
    Type: String
    Default: 'dc=example,dc=com'
    MinLength: 3
    AllowedPattern: '(dc=[^,]+)(,dc=[^,]+)*'
    ConstraintDescription: 'must be the name of the Domain Component to use as root of your LDAP domain'
  ManagerPassword: 
    Description: 'The LDAP Manager password'
    Type: String
    NoEcho: true
    MinLength: 3
  LDAPUsersLdif: 
    Description: 'The LDAP initial User database'
    Type: String
Conditions:
  HasKeyName: !Not [!Equals [!Ref KeyName, '']]
Resources: 
  #
  # Let's create the SecurityGroup for the ELB LoadBalancer. Basically it should only allow traffic on the HTTP/S port
  #   from the Internet. If you want to restrict the IP from which to accept traffic, do it here. you can have a look 
  #   at the 01-vpc.yaml, and more specifically the SecurityGroupDMZ for an example.
  #
  LoadBalancerOpenLDAP:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      Scheme: 'internal'
      Subnets: 
        - 'Fn::ImportValue': !Sub '${ParentVpcStack}-SubnetPublicAZA'
        - 'Fn::ImportValue': !Sub '${ParentVpcStack}-SubnetPublicAZB'
      Type: 'network'
      Tags: 
        - Key: PLATFORM
          Value: 
            'Fn::ImportValue': !Sub '${ParentVpcStack}-StackName'
        - Key: Name
          Value: !Sub '${AWS::StackName}-LoadBalancerOpenLDAP'
  TargetGroupOpenLDAP:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 2
      Port: 389
      Protocol: TCP
      Tags:
        - Key: PLATFORM
          Value: 
            'Fn::ImportValue': !Sub '${ParentVpcStack}-StackName'
        - Key: Name
          Value: !Sub '${AWS::StackName}-TargetGroupOpenLDAP'
      VpcId:
        'Fn::ImportValue': !Sub '${ParentVpcStack}-Vpc'
      TargetGroupAttributes:
        - Key: 'deregistration_delay.timeout_seconds'
          Value: 30
      Targets:
        - Id: !Ref OpenLDAPHost
    DependsOn: OpenLDAPHost
  ListenerOpenLDAP:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
      - TargetGroupArn: !Ref TargetGroupOpenLDAP
        Type: forward
      LoadBalancerArn: !Ref LoadBalancerOpenLDAP
      Port: 389
      Protocol: TCP
  #
  # Ok let's configure the main host then
  #
  OpenLDAPHost: 
    Type: 'AWS::EC2::Instance'
    Metadata:
      AWS::CloudFormation::Init:
        #
        # The logs for the cfn-init command are available in the instance in /var/log/cfn-init-cmd.log 
        # , InstallOpenLDAP  
        configSets: 
          default: [ Bootstrap, InstallOpenLDAP ]
        Bootstrap:
          packages:
            yum:
              htop: []
              awslogs: []
              yum-cron: []
          files:
            '/home/ec2-user/.bashrc':
              content: !Sub |
                [ -f /etc/bashrc ] && . /etc/bashrc
                alias c=clear
                alias l='ls -l'
                alias vi=vim
              mode: '000600'
              owner: 'ec2-user'
              group: 'ec2-user'
            '/root/tag_root_volume.sh':
              content: !Sub |
                #!/bin/bash
                STACK_NAME=${AWS::StackName}
                REGION=${AWS::Region}
                echo "Tagging Root volume..."
                INSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)
                VOLUME_ID=$(aws --region $REGION ec2 describe-volumes --filters "Name=attachment.instance-id,Values=$INSTANCE_ID" "Name=attachment.device,Values=/dev/xvda" --query "Volumes[0].VolumeId" --output text)
                PLATFORM=$(aws --region $REGION ec2 describe-instances --instance-ids $INSTANCE_ID --query "Reservations[0].Instances[0].Tags" --output table | grep PLATFORM | cut -d '|' -f 3 | sed -e 's/ //g')
                aws --region $REGION ec2 create-tags --resources $VOLUME_ID --tag "Key=Name,Value=$STACK_NAME-VolumeRoot"
                aws --region $REGION ec2 create-tags --resources $VOLUME_ID --tag "Key=PLATFORM,Value=$PLATFORM"
              mode: '000744'
              owner: 'root'
              group: 'root'
          commands:
            '01_install_aws_inspector': 
              command: 'wget -q -O - https://d1wk0tztpsntt1.cloudfront.net/linux/latest/install | sudo bash -s'
            '02_yum_cron_hourly.conf':
              command: "sudo sed -ibckp -E 's/^update_cmd.*/update_cmd = security/;s/^(update_messages|download_updates|apply_updates).*/\\1 = yes/' /etc/yum/yum-cron-hourly.conf"
            '03_yum_cron.conf':
              command: "sudo sed -ibckp -E 's/^(update_messages|download_updates|apply_updates).*/\\1 = yes/' /etc/yum/yum-cron.conf"
            '04_tag_root_volume':
              command: "sudo /root/tag_root_volume.sh"
          services:
            sysvinit:
              yum-cron: 
                enabled: true
                ensureRunning: true
        InstallOpenLDAP:
          packages:
            yum:
              openldap: []
              openldap-clients: []
              openldap-servers: []
          files:
            '/root/configure_ldap.sh':
              content: !Sub |
                #!/bin/bash
                managerPassword="$1"
                rootDC="$2"
                [ -z "$managerPassword" ] && echo "Invalid managerPassword" && exit 1
                [ -z "$rootDC" ] && echo "Invalid rootDC" && exit 1
                # BEWARE the 'dn' line should be equals to the file found in /etc/openldap/slapd.d/cn=config
                ldapmodify -Q -Y EXTERNAL -H ldapi:/// <<EOF
                dn: olcDatabase={2}bdb,cn=config
                changetype: modify
                replace: olcSuffix
                olcSuffix: $rootDC
                EOF
                # Changing the root DN
                echo "Changing olcRootDN to 'cn=Manager,$rootDC'..."
                ldapmodify -Q -Y EXTERNAL -H ldapi:/// <<EOF
                dn: olcDatabase={2}bdb,cn=config
                changetype: modify
                replace: olcRootDN
                olcRootDN: cn=Manager,$rootDC
                EOF
                # Adding the Root password
                echo "Changing olcRootPW..."
                ldapmodify -Q -Y EXTERNAL -H ldapi:/// <<EOF
                dn: olcDatabase={2}bdb,cn=config
                changetype: modify
                add: olcRootPW
                olcRootPW: $managerPassword
                EOF
                # TODO: explain
                # 
                domainComponent=$(echo -n "$rootDC"|cut -d',' -f1|cut -d'=' -f2)
                
                echo "Adding '$rootDC' (w/ dc=$domainComponent)..."
                ldapadd -x -D "cn=Manager,$rootDC" -w "$managerPassword" -H ldapi:/// <<EOF
                dn: $rootDC
                dc: $domainComponent
                o: LDAP Server
                description: Root entry for LDAP Server
                objectClass: top
                objectclass: dcObject
                objectclass: organization
                EOF
                if [ ! -z "${LDAPUsersLdif}" ]; then
                  echo "Loading initial LDIF user database"
                  ldapadd -x -D "cn=Manager,$rootDC" -w "$managerPassword" -H ldapi:/// -f ${LDAPUsersLdif}
                fi
              mode: '000744'
              owner: 'root'
              group: 'root'
          commands:
            '01_copy_default_config':
              command: 'sudo cp /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG'
            '02_start_slpad':
              command: 'sudo service slapd start'
            '03_configure_ldap':
              command: !Sub 'sudo /root/configure_ldap.sh ${ManagerPassword} ${RootDC}'
            '04_restart_slpad':
              command: 'sudo service slapd restart'
          services:
            sysvinit:
              slapd: 
                enabled: true
                ensureRunning: true
    Properties: 
      DisableApiTermination: false
      InstanceInitiatedShutdownBehavior: stop
      IamInstanceProfile: 
        'Fn::ImportValue': !Sub '${ParentVpcStack}-InstanceProfileTagEC2Instance'      
      ImageId:  'ami-c51e3eb6'
      InstanceType: !Ref InstanceType
      KeyName: !If [HasKeyName, !Ref KeyName, !Ref 'AWS::NoValue']
      SecurityGroupIds: 
        - 'Fn::ImportValue': !Sub '${ParentVpcStack}-SecurityGroupPrivate'
      SubnetId: 
        'Fn::ImportValue': !Sub '${ParentVpcStack}-SubnetPrivateAZA'
      Monitoring: false
      UserData:
        'Fn::Base64': !Sub |
          #!/bin/bash
          yum-config-manager --enable epel
          yum update -y
          yum install -y aws-cfn-bootstrap
          /opt/aws/bin/cfn-init --verbose --stack ${AWS::StackName} --resource OpenLDAPHost --region ${AWS::Region}
      Tags: 
        - Key: PLATFORM
          Value: 
            'Fn::ImportValue': !Sub '${ParentVpcStack}-StackName'
        - Key: Name
          Value: !Sub '${AWS::StackName}-OpenLDAPHost'
Outputs: 
  InstanceId: 
    Description: 'InstanceId of the newly created OpenLDAP instance'
    Value: !Ref OpenLDAPHost
    Export:
      Name: !Sub '${AWS::StackName}-InstanceId'
  LDAPHostname:
    Description: 'LDAP hostname to use when connecting'
    Value: !Sub '${OpenLDAPHost.PrivateDnsName}'
    Export:
      Name: !Sub '${AWS::StackName}-LDAPHostname'
  LDAPPort:
    Description: 'LDAP port to use when connecting'
    Value: 389
    Export:
      Name: !Sub '${AWS::StackName}-LDAPPort'
  RootDC: 
    Description: 'LDAP URL to use when connecting'
    Value: !Sub '${RootDC}'
    Export:
      Name: !Sub '${AWS::StackName}-RootDC'
  ManagerDN: 
    Description: 'Root DN to use when accessing the LDAP Server'
    Value: !Sub 'cn=Manager,${RootDC}'
    Export:
      Name: !Sub '${AWS::StackName}-ManagerDN'
      