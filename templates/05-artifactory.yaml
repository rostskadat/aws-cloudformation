#
# FILE: 04-artifactory.yaml
#
# DESCRIPTION: This Stack create a Artifactory Host as well as an Internet facing LoadBalancer.
#
# NOTE: in order to create the AMI mapping you can run the following command. (needs a bit of massaging: 
#   should extract the ami and the region name, and output everything in the YAML compatible format)
# 
# for region in $(aws ec2 describe-regions --query 'Regions[*].{Name:RegionName}' --output text); do
#   aws --region $region ec2 describe-images --owners amazon --filters "Name=name,Values=amzn-ami-hvm-$(date +%Y)*-gp2" "Name=architecture,Values=x86_64" "Name=root-device-type,Values=ebs" --query 'Images[*].{ID:ImageId}'
# done
#
# TODO: 
# - Should use https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/parameters-section-structure.html#aws-specific-parameter-types
# - Should configure the filestore in artifactory https://www.jfrog.com/confluence/display/RTF/Configuring+the+Filestore 
# - Should use NestedStack as described in https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-nested-stacks.html
# - Should provide alert when the platform is unhealthy
#
---
AWSTemplateFormatVersion: "2010-09-09"
Description: "This stack create a Artifactory host"
Metadata:
  'AWS::CloudFormation::Interface':
    ParameterGroups:
    - Label:
        default: 'Parent Stack'
      Parameters:
      - ParentVpcStack
      - ParentLDAPStack
      - OpenLDAPAdminPassword
    - Label: 
        default: 'EC2 Parameters'
      Parameters:
      - KeyName
      - ArtifactoryInstanceType
    - Label:
        default: 'Artifactory Parameters'
      Parameters:
      - ArtifactoryAdminPassword
    - Label:
        default: 'Artifactory DB Parameters'
      Parameters:
      - ArtifactoryDBInstanceType
      - ArtifactoryDBName
      - ArtifactoryDBAdminUsername
      - ArtifactoryDBAdminPassword
Parameters: 
  ParentVpcStack: 
    Description: "Enter the name of the VPC Stack where Artifactory will reside"
    Type: String
    MinLength: 1
    ConstraintDescription: 'must be the name of the VPC stack'
  ParentLDAPStack:
    Description: "Enter the name of the OpenLDAP Stack"
    Type: String
    MinLength: 1
    ConstraintDescription: 'must be the name of the LDAP stack'
  OpenLDAPAdminPassword: 
    Description: 'The OpenLDAP Admin password'
    Type: String
    NoEcho: true
    MinLength: 3
  KeyName: 
    Description: "The Artifactory instance Key Pair"
    Type: "AWS::EC2::KeyPair::KeyName"
    ConstraintDescription: "Must be the name of an existing EC2 KeyPair."
  ArtifactoryInstanceType:
    Description: 'The Artifactory instance type'
    Type: String
    Default: 'c4.large'    
  ArtifactoryAdminPassword: 
    Description: 'The Artifactory Admin password'
    Type: String
    MinLength: 1
    NoEcho: true
  ArtifactoryDBInstanceType:
    Description: 'The Artifactory DB instance type'
    Type: String
    Default: 'db.t2.small'    
  ArtifactoryDBName:
    Description: 'The Artifactory DB database name'
    Type: String
    Default: 'artifactorydb'    
  ArtifactoryDBAdminUsername: 
    Description: "The Artifactory DB Admin username"
    Type: String
    Default: 'admin'
  ArtifactoryDBAdminPassword: 
    Description: "The Artifactory DB Admin password"
    Type: String
    MinLength: 1
    NoEcho: true
Mappings:
  RegionMap:
    'ap-south-1':
      AMI: 'ami-76d6f519'
    'eu-west-3':
      AMI: 'ami-969c2deb'
    'eu-west-2':
      AMI: 'ami-a36f8dc4'
    'eu-west-1':
      AMI: 'ami-ca0135b3'
    'ap-northeast-2':
      AMI: 'ami-c10fa6af'
    'ap-northeast-1':
      AMI: 'ami-92df37ed'
    'sa-east-1':
      AMI: 'ami-3885d854'
    'ca-central-1':
      AMI: 'ami-338a0a57'
    'ap-southeast-1':
      AMI: 'ami-de90a5a2'
    'ap-southeast-2':
      AMI: 'ami-423bec20'
    'eu-central-1':
      AMI: 'ami-9a91b371'
    'us-east-1':
      AMI: 'ami-14c5486b'
    'us-east-2':
      AMI: 'ami-922914f7'
    'us-west-1':
      AMI: 'ami-25110f45'
    'us-west-2':
      AMI: 'ami-e251209a'    
Resources: 
  #
  # Let's create the SecurityGroup for the ELB LoadBalancer. Basically it should only allow traffic on the HTTP/S port
  #   from the Internet. If you want to restrict the IP from which to accept traffic, do it here. you can have a look 
  #   at the 01-vpc.yaml, and more specifically the SecurityGroupDMZ for an example.
  #
  SecurityGroupELB:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: 'Security Group to access Artifactory ELB'
      VpcId:
        'Fn::ImportValue': !Sub '${ParentVpcStack}-Vpc'
      SecurityGroupIngress:
      - CidrIp : "0.0.0.0/0"
        FromPort: 443
        ToPort: 443
        IpProtocol: tcp
      - CidrIp : "0.0.0.0/0"
        FromPort: 80
        ToPort: 80
        IpProtocol: tcp
      Tags: 
        - Key: PLATFORM
          Value: 
            'Fn::ImportValue': !Sub '${ParentVpcStack}-StackName'
        - Key: Name
          Value: !Sub '${AWS::StackName}-SecurityGroupELB'
  LoadBalancerArtifactory:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      Scheme: 'internet-facing'
      SecurityGroups:
      - !Ref SecurityGroupELB
      Subnets: 
        - 'Fn::ImportValue': !Sub '${ParentVpcStack}-SubnetPublicAZA'
        - 'Fn::ImportValue': !Sub '${ParentVpcStack}-SubnetPublicAZB'
      Tags: 
        - Key: PLATFORM
          Value: 
            'Fn::ImportValue': !Sub '${ParentVpcStack}-StackName'
        - Key: Name
          Value: !Sub '${AWS::StackName}-LoadBalancerArtifactory'
  TargetGroupArtifactory:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckIntervalSeconds: 10
      HealthCheckPath: '/artifactory/webapp/#/home'
      HealthCheckTimeoutSeconds: 2
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 2
      Matcher:
        HttpCode: '200-299'
      Port: 8081
      Protocol: HTTP
      Tags:
        - Key: PLATFORM
          Value: 
            'Fn::ImportValue': !Sub '${ParentVpcStack}-StackName'
        - Key: Name
          Value: !Sub '${AWS::StackName}-TargetGroupArtifactory'
      VpcId:
        'Fn::ImportValue': !Sub '${ParentVpcStack}-Vpc'
      TargetGroupAttributes:
        - Key: 'deregistration_delay.timeout_seconds'
          Value: 30
      Targets:
        - Id: !Ref ArtifactoryHost
    DependsOn: ArtifactoryHost
  ListenerArtifactory:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
      - TargetGroupArn: !Ref TargetGroupArtifactory
        Type: forward
      LoadBalancerArn: !Ref LoadBalancerArtifactory
      Port: 80
      Protocol: HTTP
  #
  # Let's create the Artifactory instance.
  # 
  # TODO: Should have a specific SecurityGroup for the instance in order to only allow traffic on port 8000 (default
  #   Artifactory port). Further more I should enable SSL traffic, but beware that the load balancer might not allow 
  #   communications with a host presenting a self-signed certificate.
  #
  SecurityGroupArtifactory:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: 'Security Group to access the Artifactory instance'
      VpcId:
        'Fn::ImportValue': !Sub '${ParentVpcStack}-Vpc'
      SecurityGroupIngress:
      - SourceSecurityGroupId: 
          !Ref 'SecurityGroupELB'
        FromPort: 8081
        ToPort: 8081
        IpProtocol: tcp
      Tags: 
        - Key: PLATFORM
          Value: 
            'Fn::ImportValue': !Sub '${ParentVpcStack}-StackName'
        - Key: Name
          Value: !Sub '${AWS::StackName}-SecurityGroupArtifactory'
  SecurityGroupDB:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: 'Security Group to access the Artifactory DB'
      VpcId:
        'Fn::ImportValue': !Sub '${ParentVpcStack}-Vpc'
      SecurityGroupIngress:
      - SourceSecurityGroupId:
          !Ref 'SecurityGroupArtifactory'
        FromPort: 3306
        ToPort: 3306
        IpProtocol: tcp
      Tags: 
        - Key: PLATFORM
          Value: 
            'Fn::ImportValue': !Sub '${ParentVpcStack}-StackName'
        - Key: Name
          Value: !Sub '${AWS::StackName}-SecurityGroupDB'
  DBSubnetGroupDB:
    Type: "AWS::RDS::DBSubnetGroup"
    Properties: 
      DBSubnetGroupDescription: 'The subnet where the Artifactory DB reside'
      DBSubnetGroupName: !Sub '${AWS::StackName}-DBSubnetGroupDB'
      SubnetIds:
        - 'Fn::ImportValue': !Sub '${ParentVpcStack}-SubnetPrivateAZA'
        - 'Fn::ImportValue': !Sub '${ParentVpcStack}-SubnetPrivateAZB'
      Tags:
        - Key: PLATFORM
          Value: 
            'Fn::ImportValue': !Sub '${ParentVpcStack}-StackName'
        - Key: Name
          Value: !Sub '${AWS::StackName}-DBSubnetGroupDB'
  #
  # The backend database for artifactory
  #
  DBParameterGroupDB:
    Type: 'AWS::RDS::DBParameterGroup'
    Properties: 
      Description: 'Parameters necessary for Artifactory DB'
      Family: 'mysql5.6'
      # These parameters are from https://www.jfrog.com/confluence/display/RTF/MySQL
      Parameters: { "max_allowed_packet": 8388608, "tmp_table_size": 536870912, "max_heap_table_size": 536870912, "innodb_log_file_size": 268435456 }
      Tags:
        - Key: PLATFORM
          Value: 
            'Fn::ImportValue': !Sub '${ParentVpcStack}-StackName'
        - Key: Name
          Value: !Sub '${AWS::StackName}-DBParameterGroupDB'
  ArtifactoryDB: 
    Type: 'AWS::RDS::DBInstance'
    Properties:
      AllocatedStorage: 20
      AutoMinorVersionUpgrade: true
      AvailabilityZone: 
        'Fn::ImportValue': !Sub '${ParentVpcStack}-AvailabilityZoneSubnetPrivateAZA'
      BackupRetentionPeriod: 7
      CopyTagsToSnapshot: true
      DBInstanceClass: !Ref ArtifactoryDBInstanceType
      DBName: !Ref ArtifactoryDBName
      DBParameterGroupName: !Ref DBParameterGroupDB
      DBSubnetGroupName: !Ref DBSubnetGroupDB
      Engine: mysql
      EngineVersion: '5.6.39'
      MasterUsername: !Ref ArtifactoryDBAdminUsername
      MasterUserPassword: !Ref ArtifactoryDBAdminPassword
      PreferredBackupWindow: "01:00-03:00"
      PreferredMaintenanceWindow: "Sun:03:01-Sun:05:00"
      MultiAZ: false
      StorageEncrypted: true
      StorageType: gp2
      VPCSecurityGroups:
        - 'Fn::ImportValue': !Sub '${ParentVpcStack}-SecurityGroupPrivate'
        - !Ref SecurityGroupDB
      Tags:
        - Key: PLATFORM
          Value: 
            'Fn::ImportValue': !Sub '${ParentVpcStack}-StackName'
        - Key: Name
          Value: !Sub '${AWS::StackName}-ArtifactoryDB'
    
  #
  # Ok let's configure the main host then
  #
  ArtifactoryHost: 
    Type: 'AWS::EC2::Instance'
    Metadata:
      AWS::CloudFormation::Init:
        #
        # The logs for the cfn-init command are available in the instance in /var/log/cfn-init-cmd.log 
        # InstallArtifactory, InstallArtifactoryApps, StartArtifactory 
        configSets: 
          default: [ Bootstrap, InstallArtifactory ]
        Bootstrap:
          packages:
            yum:
              htop: []
              awslogs: []
              yum-cron: []
          files:
            '/home/ec2-user/.bashrc':
              content: !Sub |
                [ -f /etc/bashrc ] && . /etc/bashrc
                alias c=clear
                alias l='ls -l'
                alias vi=vim
              mode: '000600'
              owner: 'ec2-user'
              group: 'ec2-user'
            '/root/tag_root_volume.sh':
              content: !Sub |
                #!/bin/bash
                STACK_NAME=${AWS::StackName}
                REGION=${AWS::Region}
                echo "Tagging Root volume..."
                INSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)
                VOLUME_ID=$(aws --region $REGION ec2 describe-volumes --filters "Name=attachment.instance-id,Values=$INSTANCE_ID" "Name=attachment.device,Values=/dev/xvda" --query "Volumes[0].VolumeId" --output text)
                PLATFORM=$(aws --region $REGION ec2 describe-instances --instance-ids $INSTANCE_ID --query "Reservations[0].Instances[0].Tags" --output table | grep PLATFORM | cut -d '|' -f 3 | sed -e 's/ //g')
                aws --region $REGION ec2 create-tags --resources $VOLUME_ID --tag "Key=Name,Value=$STACK_NAME-VolumeRoot"
                aws --region $REGION ec2 create-tags --resources $VOLUME_ID --tag "Key=PLATFORM,Value=$PLATFORM"
              mode: '000744'
              owner: 'root'
              group: 'root'
            '/etc/yum.repos.d/bintray-jfrog-artifactory-rpms.repo':
              source: 'https://bintray.com/jfrog/artifactory-rpms/rpm'
              mode: "000644"
              owner: "root"
              group: "root"
          commands:
            '01_install_aws_inspector': 
              command: 'wget -q -O - https://d1wk0tztpsntt1.cloudfront.net/linux/latest/install | sudo bash -s'
            '02_yum_cron_hourly.conf':
              command: "sudo sed -ibckp -E 's/^update_cmd.*/update_cmd = security/;s/^(update_messages|download_updates|apply_updates).*/\\1 = yes/' /etc/yum/yum-cron-hourly.conf"
            '03_yum_cron.conf':
              command: "sudo sed -ibckp -E 's/^(update_messages|download_updates|apply_updates).*/\\1 = yes/' /etc/yum/yum-cron.conf"
            '04_tag_root_volume':
              command: "sudo /root/tag_root_volume.sh"
            '05_remove_jdk7':
              command: 'sudo yum remove -y java-1.7.0-openjdk'
          services:
            sysvinit:
              yum-cron: 
                enabled: true
                ensureRunning: true
        InstallArtifactory: 
          packages:
            yum:
              mysql56: []
              java-1.8.0-openjdk: []
              mysql-connector-java: []
              jfrog-artifactory-oss: []
          files:
            '/etc/opt/jfrog/artifactory/db.properties':
              content: !Sub |
                type=mysql
                driver=com.mysql.jdbc.Driver
                url=jdbc:mysql://${ArtifactoryDB.Endpoint.Address}:${ArtifactoryDB.Endpoint.Port}/${ArtifactoryDBName}?characterEncoding=UTF-8&elideSetAutoCommits=true
                username=artifactory
                password=password
              mode: '000740'
              owner: 'artifactory'
              group: 'artifactory'
            '/root/artifactory_createdb.sh':
              content: !Sub |
                #!/bin/bash
                username=$1
                password=$2
                [ -z "$username" ] && echo "Invalid username" && exit
                [ -z "$password" ] && echo "Invalid password" && exit
                mysql -h ${ArtifactoryDB.Endpoint.Address} -P ${ArtifactoryDB.Endpoint.Port} --user=$username --password=$password <<EOF
                -- CREATE DATABASE ${ArtifactoryDBName} CHARACTER SET utf8 COLLATE utf8_bin;
                GRANT ALL on ${ArtifactoryDBName}.* TO 'artifactory'@'%' IDENTIFIED BY 'password';
                FLUSH PRIVILEGES;
                EOF
              mode: '000700'
              owner: 'root'
              group: 'root'
            '/root/artifactory_change_password.sh':
              content: |
                #!/bin/bash
                oldPassword="$1"
                newPassword="$2"
                [ -z "$oldPassword" ] && echo "Invalid old password" && exit
                [ -z "$newPassword" ] && echo "Invalid new password" && exit
                API_URL="http://localhost:8081/artifactory/api"
                header="Content-type: application/json"
                data='{ "userName":"admin", "oldPassword":"'"$oldPassword"'", "newPassword1":"'"$newPassword"'", "newPassword2":"'"$newPassword"'"}'
                url="$API_URL/security/users/authorization/changePassword"
                echo -n "Changing default password for user admin"
                while (true); do
                        result=$(curl -s --user "admin:$oldPassword" -H "$header" -d "$data" -X POST "$url")
                        [ $(echo -n "$result" | grep -c "Password has been successfully changed") -gt 0 ] && exit
                        echo -n "."
                        sleep 2
                done
              mode: '000700'
              owner: 'root'
              group: 'root'
            '/root/artifactory_configure_ldap.sh':
              content: |
                #!/bin/bash
                artifactoryPassword="$1"
                ldapUrl="$2"
                domainComponent="$3"
                ldapPassword="$4"
                [ -z "$artifactoryPassword" ] && echo "Invalid artifactoryPassword" && exit
                [ -z "$ldapUrl" ] && echo "Invalid ldapUrl" && exit
                [ -z "$domainComponent" ] && echo "Invalid domainComponent" && exit
                [ -z "$ldapPassword" ] && echo "Invalid ldap password" && exit
                
                API_URL="http://localhost:8081/artifactory/api"
                header="Content-Type: application/yaml"
                url="$API_URL/system/configuration"
                echo "Configuring LDAP ($ldapUrl w/ $domainComponent) ..."
                cat > /root/ldap_settings.yaml <<EOF
                security:
                  ldapSettings:
                    OpenLDAP:
                      emailAttribute: mail
                      ldapPoisoningProtection: true
                      ldapUrl: '$ldapUrl'
                      search:
                        managerDn: 'cn=Manager,dc=$domainComponent,dc=local'
                        managerPassword: $ldapPassword
                        searchBase: ou=People
                        searchFilter: (uid={0})
                        searchSubTree: true
                      allowUserToAccessProfile: true
                      autoCreateUser: true
                      enabled: true
                EOF
                curl -s --user "admin:$artifactoryPassword" -H "$header" -T /root/ldap_settings.yaml -X PATCH "$url"
              mode: '000700'
              owner: 'root'
              group: 'root'
          commands:
            '01_artifactory_createdb':
              command: !Sub 'sudo /root/artifactory_createdb.sh ${ArtifactoryDBAdminUsername} ${ArtifactoryDBAdminPassword}'
            '02_alternatives':
              command: 'sudo /usr/sbin/alternatives --set java /usr/lib/jvm/jre-1.8.0-openjdk.x86_64/bin/java'              
            '03_create_symlink_for_mysql':
              command: 'sudo ln -s /usr/share/java/mysql-connector-java.jar /var/opt/jfrog/artifactory/tomcat/lib/mysql-connector-java.jar'
            '04_artifactory_start':
              command: 'sudo service artifactory start'
            '05_artifactory_change_password': 
              command: !Sub 'sudo /root/artifactory_change_password.sh password ${ArtifactoryAdminPassword}'
            '06_artifactory_configure_ldap': 
              command: !Join
                - ' '
                - - 'sudo /root/artifactory_configure_ldap.sh'
                  - !Sub '${ArtifactoryAdminPassword}'
                  - 'Fn::ImportValue': !Sub '${ParentLDAPStack}-LDAPUrl'
                  - 'Fn::ImportValue': !Sub '${ParentLDAPStack}-RootDC'
                  - !Sub '${OpenLDAPAdminPassword}'
            '07_artifactory_restart': 
              command: 'sudo service artifactory restart'
          services: 
            sysvinit: 
              artifactory: 
                enabled: true
                ensureRunning: true
    Properties: 
      DisableApiTermination: false
      InstanceInitiatedShutdownBehavior: stop
      IamInstanceProfile: 
        'Fn::ImportValue': !Sub '${ParentVpcStack}-InstanceProfileTagEC2Instance'      
      ImageId: !FindInMap [RegionMap, !Ref 'AWS::Region', AMI]
      InstanceType: !Ref ArtifactoryInstanceType
      KeyName: !Ref 'KeyName'
      SecurityGroupIds: 
        - 'Fn::ImportValue': !Sub '${ParentVpcStack}-SecurityGroupPrivate'
        - !Ref SecurityGroupArtifactory
      SubnetId: 
        'Fn::ImportValue': !Sub '${ParentVpcStack}-SubnetPrivateAZA'
      Volumes: 
        - VolumeId: !Ref VolumeData
          Device: '/dev/xvdb'
      Monitoring: false
      UserData:
        'Fn::Base64': !Sub |
          #!/bin/bash
          yum-config-manager --enable epel
          yum update -y
          yum install -y aws-cfn-bootstrap
          /opt/aws/bin/cfn-init --verbose --stack ${AWS::StackName} --resource ArtifactoryHost --region ${AWS::Region}
      Tags: 
        - Key: PLATFORM
          Value: 
            'Fn::ImportValue': !Sub '${ParentVpcStack}-StackName'
        - Key: Name
          Value: !Sub '${AWS::StackName}-ArtifactoryHost'
    DependsOn: VolumeData
    DependsOn: ArtifactoryDB
  VolumeData:
    Type: 'AWS::EC2::Volume'
    Properties:
      Size: 500
      Encrypted: true
      AvailabilityZone: 
        'Fn::ImportValue': !Sub '${ParentVpcStack}-AvailabilityZoneSubnetPrivateAZA'
      Tags: 
        - Key: PLATFORM
          Value: 
            'Fn::ImportValue': !Sub '${ParentVpcStack}-StackName'
        - Key: Name
          Value: !Sub '${AWS::StackName}-VolumeData'
Outputs: 
  InstanceId: 
    Description: "InstanceId of the newly created Artifactory instance"
    Value: !Ref ArtifactoryHost
    Export:
      Name: !Sub '${AWS::StackName}-InstanceId'
  DNSName: 
    Description: "Public DNS address of the internet facing ELB"
    Value: !Sub '${LoadBalancerArtifactory.DNSName}'
    Export:
      Name: !Sub '${AWS::StackName}-DNSName'
      